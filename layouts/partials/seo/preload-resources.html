{{/* Preload critical fonts - only if enabled and fonts exist */}}
{{ if and site.Params.seo.preload_fonts site.Params.fonts.preload }}
  {{ range site.Params.fonts.preload }}
    <link rel="preload" href="{{ .url }}" as="font" type="{{ .type }}" crossorigin>
  {{ end }}
{{ end }}

{{/* Preload external fonts without integrity checks */}}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

{{/* Preload critical CSS - only if enabled and CSS exists */}}
{{ if site.Params.seo.critical_css }}
  {{ $mainCSS := resources.Get "css/main.css" }}
  {{ if $mainCSS }}
    {{ $css := $mainCSS | resources.Minify | fingerprint }}
    <link rel="preload" href="{{ $css.RelPermalink }}" as="style">
  {{ end }}
{{ end }}

{{/* Preload hero/featured images - with existence check */}}
{{ with .Params.image }}
  {{ $image := resources.Get . }}
  {{ if $image }}
    {{ $optimized := $image.Resize "800x400" }}
    <link rel="preload" 
          href="{{ $optimized.RelPermalink }}" 
          as="image" 
          imagesrcset="{{ $optimized.RelPermalink }} 800w"
          imagesizes="(max-width: 800px) 100vw, 800px">
  {{ end }}
{{ end }}

{{/* Preload first portfolio images */}}
{{ if eq .Type "portfolio" }}
  {{ $images := .Resources.ByType "image" }}
  {{ range first 4 $images }}
    {{ $thumb := .Resize "300x300" }}
    <link rel="preload" href="{{ $thumb.RelPermalink }}" as="image">
  {{ end }}
{{ end }}

{{/* DNS prefetch for external resources - conditional based on analytics */}}
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//fonts.gstatic.com">

{{/* Preconnect to critical third-party origins */}}
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

{{/* Conditional DNS prefetch based on enabled analytics */}}
{{ with site.Params.analytics }}
  {{ if .plausible }}
    {{ $parsed := urls.Parse .plausibleScriptSrc }}
    <link rel="dns-prefetch" href="{{ printf "%s://%s" $parsed.Scheme $parsed.Host }}">
  {{ end }}
  {{ if .umami }}
    {{ $parsed := urls.Parse .umamiScriptSrc }}
    <link rel="dns-prefetch" href="{{ printf "%s://%s" $parsed.Scheme $parsed.Host }}">
  {{ end }}
  {{ if .matomo }}
    {{ $parsed := urls.Parse .matomoURL }}
    <link rel="dns-prefetch" href="{{ printf "%s://%s" $parsed.Scheme $parsed.Host }}">
  {{ end }}
{{ end }}

{{/* CDN prefetch only if needed */}}
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">
<link rel="dns-prefetch" href="//d3js.org">

{{/* Conditional preloads based on page type */}}
{{ if eq .Type "posts" }}
  {{ $postsJS := resources.Get "js/posts.js" }}
  {{ if $postsJS }}
    {{ $postsMin := $postsJS | js.Build | minify | fingerprint }}
    <link rel="preload" href="{{ $postsMin.RelPermalink }}" as="script">
  {{ end }}
{{ end }}

{{ if .Store.Get "hasMermaid" }}
  {{ $mermaidJS := resources.Get "js/mermaid.min.js" }}
  {{ if $mermaidJS }}
    {{ $mermaidMin := $mermaidJS | minify | fingerprint }}
    <link rel="preload" href="{{ $mermaidMin.RelPermalink }}" as="script">
  {{ end }}
{{ end }}
