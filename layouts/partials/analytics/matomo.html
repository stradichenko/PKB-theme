{{- with .Site.Params.analytics -}}
  {{- if .matomo -}}
    <!-- Matomo -->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      
      // CORS-friendly configuration
      _paq.push(['setRequestMethod', 'POST']);
      _paq.push(['enableCrossDomainLinking']);
      
      (function() {
        var u="{{ .matomoURL | default "//localhost:8080/" }}";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '{{ .matomoSiteId | default "1" }}']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; 
        g.src=u+'matomo.js'; 
        g.crossOrigin = 'anonymous';
        g.onerror = function() {
          console.warn('Matomo: Script loading failed, attempting fallback tracking');
          window.matomoFallbackTracking();
        };
        s.parentNode.insertBefore(g,s);
      })();
      
      // CORS-aware fallback tracking function
      window.matomoFallbackTracking = function() {
        var trackingUrl = '{{ .matomoURL }}matomo.php';
        var params = new URLSearchParams({
          'idsite': '{{ .matomoSiteId }}',
          'rec': '1',
          'action_name': document.title,
          'url': window.location.href,
          'urlref': document.referrer,
          'rand': Math.floor(Math.random() * 1000000),
          'h': new Date().getHours(),
          'm': new Date().getMinutes(),
          's': new Date().getSeconds()
        });
        
        // Try fetch with CORS
        fetch(trackingUrl + '?' + params.toString(), {
          method: 'GET',
          mode: 'cors',
          credentials: 'omit',
          headers: {
            'Accept': 'image/gif, image/png, */*'
          }
        }).catch(function() {
          // Final fallback: pixel tracking
          var img = document.createElement('img');
          img.src = trackingUrl + '?' + params.toString();
          img.style.position = 'absolute';
          img.style.left = '-1000px';
          img.style.width = '1px';
          img.style.height = '1px';
          img.crossOrigin = 'anonymous';
          document.body.appendChild(img);
        });
      };
    </script>
    
    <!-- CSP-Friendly Matomo Tracking Fallback -->
    <script>
    // Enhanced CORS error handling
    window.addEventListener('load', function() {
      if (typeof _paq !== 'undefined' && !window.Matomo) {
        console.warn('Matomo: Standard tracking blocked, using CORS-friendly fallback');
        window.matomoFallbackTracking();
      }
    });
    </script>
  {{- end -}}
{{- end -}}
