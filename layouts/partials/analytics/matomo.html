{{- with .Site.Params.analytics -}}
  {{- if .matomo -}}
    <!-- Matomo -->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="{{ .matomoURL | default "//localhost:8080/" }}";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '{{ .matomoSiteId | default "1" }}']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code -->

    <!-- CSP-Friendly Matomo Tracking Fallback -->
    <script>
    // Check if standard Matomo tracking failed due to CSP
    window.addEventListener('load', function() {
      // If _paq is defined but matomo.js failed to load, use fallback
      if (typeof _paq !== 'undefined' && !window.Matomo) {
        console.warn('Matomo: Standard tracking blocked, using CSP-friendly fallback');
        
        // Manual tracking without loading external scripts
        fetch('{{ .matomoURL }}matomo.php?' + new URLSearchParams({
          'idsite': '{{ .matomoSiteId }}',
          'rec': '1',
          'action_name': document.title,
          'url': window.location.href,
          'urlref': document.referrer,
          'rand': Math.floor(Math.random() * 1000000),
          'h': new Date().getHours(),
          'm': new Date().getMinutes(),
          's': new Date().getSeconds()
        }), {
          method: 'GET',
          mode: 'no-cors'
        }).catch(function() {
          // Ultimate fallback: use image pixel for tracking
          var img = document.createElement('img');
          img.src = '{{ .matomoURL }}matomo.php?idsite={{ .matomoSiteId }}&rec=1&action_name=' + 
                    encodeURIComponent(document.title) + '&url=' + 
                    encodeURIComponent(window.location.href) + '&rand=' + 
                    Math.floor(Math.random() * 1000000);
          img.style.position = 'absolute';
          img.style.left = '-1000px';
          img.style.width = '1px';
          img.style.height = '1px';
          document.body.appendChild(img);
        });
      }
    });
    </script>
  {{- end -}}
{{- end -}}
