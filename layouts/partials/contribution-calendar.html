<div class="contribution-section">
  <h2 class="contribution-title">Activity Calendar</h2>
  <div class="contribution-calendar">
    <div class="calendar-box">
      {{ $posts := where .Site.RegularPages "Type" "in" .Site.Params.taxonomies.mainSections }}

      {{ $now := now }}
      {{ $startDate := $now.AddDate 0 0 -365 }}

      <!-- Build a map of dates to activity counts -->
      {{ $dateMap := dict }}
      {{ range $posts }}
        {{ $dates := slice (.Date.Format "2006-01-02") (.Lastmod.Format "2006-01-02") }}
        {{ range $date := $dates }}
          {{ $count := index $dateMap $date | default 0 }}
          {{ $dateMap = merge $dateMap (dict $date (add $count 1)) }}
        {{ end }}
      {{ end }}

      <!-- Calculate month label positions -->
      {{ $monthPositions := dict }}
      {{ $lastMonth := "" }}
      {{ range $dayOffset := seq 0 365 }}
        {{ $intDayOffset := int $dayOffset }}
        {{ $date := $startDate.AddDate 0 0 $intDayOffset }}
        {{ $month := $date.Format "2006-01" }}
        {{ if ne $month $lastMonth }}
          {{ $monthName := $date.Format "Jan" }}
          {{ $weekNum := div $intDayOffset 7 }}
          {{ $position := mul $weekNum 14 }}
          {{ $monthPositions = merge $monthPositions (dict $monthName $position) }}
          {{ $lastMonth = $month }}
        {{ end }}
      {{ end }}

      <!-- Calendar visualization -->
      <div class="calendar-container">
        <div class="calendar-wrapper">

          <!-- Month labels -->
          <div class="calendar-months">
            {{ range $month, $pos := $monthPositions }}
              <div class="month-label" data-month="{{ $month }}" style="left: {{ $pos }}px;">{{ $month }}</div>
            {{ end }}
          </div>

          <!-- Calendar grid: 7 rows (days), 52 cols (weeks) -->
          <div class="calendar-cells">
            {{ range $dayOfWeek := seq 0 6 }}
              <div class="calendar-row">
                {{ range $week := seq 0 51 }}
                  {{ $dayOffset := add (mul $week 7) $dayOfWeek }}
                  {{ $intDayOffset := int $dayOffset }}
                  {{ $currentDate := $startDate.AddDate 0 0 $intDayOffset }}
                  {{ $dateStr := $currentDate.Format "2006-01-02" }}
                  {{ $monthName := $currentDate.Format "Jan" }}
                  {{ $count := index $dateMap $dateStr | default 0 }}

                  {{/* Determine level by count */}}
                  {{ $level := cond (gt $count 10) 4 (cond (gt $count 7) 3 (cond (gt $count 4) 2 (cond (gt $count 0) 1 0))) }}

                  <div 
                    class="calendar-cell level-{{ $level }}" 
                    data-date="{{ $dateStr }}" 
                    data-month="{{ $monthName }}" 
                    data-count="{{ $count }}" 
                    title="{{ $dateStr }}: {{ $count }} activities"
                  ></div>
                {{ end }}
              </div>
            {{ end }}
          </div>

        </div>
      </div>

      <!-- Legend -->
      <div class="calendar-legend">
        <span class="legend-label">Less</span>
        <div class="legend-cells">
          <div class="calendar-cell level-0" title="No activity"></div>
          <div class="calendar-cell level-1" title="1-3 activities"></div>
          <div class="calendar-cell level-2" title="4-6 activities"></div>
          <div class="calendar-cell level-3" title="7-10 activities"></div>
          <div class="calendar-cell level-4" title="10+ activities"></div>
        </div>
        <span class="legend-label">More</span>
      </div>
    </div>
  </div>
</div>
