<div class="about-profile-container">
  <div class="lda-box">
    <h2 class="lda-title">Topic Analysis (LDA)</h2>
    
    <div class="lda-container">
    </div>
    
  </div>
</div>

<!-- Embed document data for LDA analysis -->
<script type="application/json" id="lda-documents-data">
[
  {{ $first := true }}
  {{ range where .Site.Pages "Section" "in" (slice "posts" "docs") }}
    {{ $first = false }}
  {{ end }}
]
</script>

<!-- Load LDA CSS -->
{{ with resources.Get "css/components/lda-analysis.css" }}
  {{ $ldaCSS := . | minify | fingerprint }}
  <link rel="stylesheet" href="{{ $ldaCSS.RelPermalink }}" integrity="{{ $ldaCSS.Data.Integrity }}" crossorigin="anonymous">
{{ end }}

<!-- Optimized mobile interaction and tooltip script -->
<script>
(function() {
  'use strict';
  
  // Cache DOM elements and state
  let toggleBtn, container, toggleText, tooltip;
  let showingTable = false;
  
  document.addEventListener('DOMContentLoaded', function() {
    initializeTooltipFunctions();
  });
  
  function handleToggleView() {
    showingTable = !showingTable;
    
    if (showingTable) {
      container.classList.add('show-table');
      toggleText.textContent = 'Switch to Chart View';
    } else {
      container.classList.remove('show-table');
      toggleText.textContent = 'Switch to Table View';
    }
  }
  
  function initializeTooltipFunctions() {
    window.showTopicTooltip = function(event, topicData) {
      const tooltip = document.getElementById('topic-tooltip');
      if (!tooltip) return;
      
      // Calculate position
      const rect = event.target.getBoundingClientRect();
      const top = rect.bottom + window.scrollY + 10;
      
      tooltip.style.top = top + 'px';
      tooltip.classList.add('visible');
    };
    
    window.hideTopicTooltip = function() {
      const tooltip = document.getElementById('topic-tooltip');
      if (tooltip) {
        tooltip.classList.remove('visible');
      }
    };
    
    // Hide tooltip when clicking elsewhere
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.topic-bar-container')) {
        window.hideTopicTooltip();
      }
    });
  }

  // Initialize tooltip functions immediately
  initializeTooltipFunctions();
})();
</script>

<!-- Load external libraries with proper async loading and deduplication -->
<script>
(function() {
  'use strict';
  
  // Global library loading state
  window.PKBLibraryLoader = window.PKBLibraryLoader || {
    tf: { loaded: false, loading: false, callbacks: [] },
    d3: { loaded: false, loading: false, callbacks: [] }
  };
  
  function loadLibrary(name, src, callback) {
    const lib = window.PKBLibraryLoader[name];
    
    // If already loaded
    if (lib.loaded || window[name]) {
      lib.loaded = true;
      if (callback) callback();
      return;
    }
    
    // Add to callback queue
    if (callback) lib.callbacks.push(callback);
    
    // If already loading, don't load again
    if (lib.loading) return;
    
    lib.loading = true;
    const script = document.createElement('script');
    script.src = src;
    script.async = true;
    
    script.onload = function() {
      lib.loaded = true;
      lib.loading = false;
      // Execute all callbacks
      lib.callbacks.forEach(cb => cb());
      lib.callbacks = [];
    };
    
    script.onerror = function() {
      console.warn(`Failed to load ${name} from ${src}`);
      lib.loading = false;
      // Still execute callbacks to prevent hanging
      lib.callbacks.forEach(cb => cb());
      lib.callbacks = [];
    };
    
    document.head.appendChild(script);
  }
  
  function initializeLDAAnalysis() {
    // Only initialize if both libraries are available
    if ((window.tf || window.PKBLibraryLoader.tf.loaded) && 
        (window.d3 || window.PKBLibraryLoader.d3.loaded)) {
      if (typeof window.initLDAAnalysis === 'function') {
        window.initLDAAnalysis();
      }
    }
  }
  
  // Load TensorFlow.js first, then D3.js
  loadLibrary('tf', 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js', function() {
    loadLibrary('d3', 'https://d3js.org/d3.v7.min.js', initializeLDAAnalysis);
  });
})();
</script>

<!-- Load LDA analysis script -->
{{ with resources.Get "js/lda-analysis.js" }}
  {{ $ldaJS := . | js.Build | minify | fingerprint }}
  <script src="{{ $ldaJS.RelPermalink }}" integrity="{{ $ldaJS.Data.Integrity }}" crossorigin="anonymous" defer></script>
{{ end }}
    }
  }
})();
</script>

<!-- Load LDA analysis script -->
{{ with resources.Get "js/lda-analysis.js" }}
  {{ $ldaJS := . | js.Build | minify | fingerprint }}
  <script src="{{ $ldaJS.RelPermalink }}" integrity="{{ $ldaJS.Data.Integrity }}" crossorigin="anonymous"></script>
{{ end }}
    window.hideTopicTooltip = function() {
      if (tooltip) {
        tooltip.classList.remove('visible');
      }
    };
    
    // Hide tooltip when clicking elsewhere
    document.addEventListener('click', function(event) {
      if (tooltip && !event.target.closest('.topic-bar-container')) {
        window.hideTopicTooltip();
      }
    });
  }
})();
</script>

<!-- Load external libraries with error handling -->
<script>
// Check if libraries are already loaded to avoid duplicates
if (typeof tf === 'undefined') {
  document.write('<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"><\/script>');
}
if (typeof d3 === 'undefined') {
  document.write('<script src="https://d3js.org/d3.v7.min.js"><\/script>');
}
</script>

<!-- Load LDA analysis script -->
{{ with resources.Get "js/lda-analysis.js" }}
  {{ $ldaJS := . | js.Build | minify | fingerprint }}
  <script src="{{ $ldaJS.RelPermalink }}" integrity="{{ $ldaJS.Data.Integrity }}" crossorigin="anonymous"></script>
{{ end }}
