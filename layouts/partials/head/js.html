<!-- Theme initialization script - must run BEFORE CSS loads to avoid FOUC -->
<script>
  (function() {
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const currentTheme = localStorage.getItem('theme') || 
                       (prefersDarkScheme.matches ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', currentTheme);
    
    // Prevent flash of incorrect theme background
    document.documentElement.style.backgroundColor = 
      currentTheme === 'dark' ? '#1a202c' : '#275f85';
  })();
</script>

<!-- Inline critical JS for performance -->
{{ $criticalJS := resources.Get "js/critical.js" }}
{{ if $criticalJS }}
  <script>{{ $criticalJS.Content | safeJS }}</script>
{{ end }}

<!-- Main bundle (code-split, minified, fingerprinted) -->
{{ $mainJS := resources.Get "js/main.js" }}
{{ if $mainJS }}
  {{ if eq hugo.Environment "development" }}
    <!-- Unminified bundle for development -->
    {{ with $mainJS | js.Build }}
      <script src="{{ .RelPermalink }}"></script>
    {{ end }}
  {{ else }}
    <!-- Minified, fingerprinted bundle for production with integrity -->
    {{ $mainMin := $mainJS | js.Build (dict "minify" true) | fingerprint }}
    <script src="{{ $mainMin.RelPermalink }}" integrity="{{ $mainMin.Data.Integrity }}" crossorigin="anonymous" defer></script>
  {{ end }}
{{ end }}
