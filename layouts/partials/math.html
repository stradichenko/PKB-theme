<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true,
      packages: {'[+]': ['base', 'ams', 'newcommand', 'mhchem']},
      macros: {
        // Common mathematical macros
        R: '{\\mathbb{R}}',
        N: '{\\mathbb{N}}',
        Z: '{\\mathbb{Z}}',
        Q: '{\\mathbb{Q}}',
        C: '{\\mathbb{C}}'
      }
    },
    options: {
      ignoreHtmlClass: 'tex2jax_ignore',
      processHtmlClass: 'tex2jax_process'
    },
    chtml: {
      scale: 1,
      minScale: 0.5,
      matchFontHeight: false
    },
    startup: {
      ready: function () {
        MathJax.startup.defaultReady();
        console.log('MathJax is loaded and ready.');

        // Define reprocessMath globally for dynamic content
        window.reprocessMath = function (retryCount = 0) {
          if (retryCount > 3) {
            console.warn('MathJax reprocessing failed after 3 retries');
            return;
          }

          if (window.MathJax && MathJax.typesetPromise) {
            MathJax.typesetPromise()
              .then(() => {
                console.log('MathJax processing completed successfully');
              })
              .catch((err) => {
                console.warn('MathJax typeset failed, retrying...', err.message);
                setTimeout(() => window.reprocessMath(retryCount + 1), 300);
              });
          } else {
            setTimeout(() => window.reprocessMath(retryCount + 1), 200);
          }
        };

        // MutationObserver to catch dynamically added math content
        const observer = new MutationObserver((mutations) => {
          let hasNewMath = false;
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList') {
              mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1) {
                  const text = node.textContent || '';
                  if (text.includes('$') || text.includes('\\(') || text.includes('\\[')) {
                    hasNewMath = true;
                  }
                }
              });
            }
          });

          // Use debounced math reprocessing to prevent excessive calls
          const debouncedMathReprocess = window.PKBUtils?.debounce(() => {
            if (window.reprocessMath) window.reprocessMath();
          }, 150) || (() => setTimeout(() => window.reprocessMath(), 150));

          if (hasNewMath) {
            debouncedMathReprocess();
          }
        });

        // Start observing after initial load
        document.addEventListener('DOMContentLoaded', () => {
          observer.observe(document.body, {
            childList: true,
            subtree: true
          });

          // Initial processing after DOM is ready
          const debouncedMathReprocess = window.PKBUtils?.debounce(() => {
            if (window.reprocessMath) window.reprocessMath();
          }, 150) || (() => setTimeout(() => window.reprocessMath(), 150));
          debouncedMathReprocess();
        });

        // Additional processing on window load for safety
        window.addEventListener('load', () => {
          const debouncedMathReprocess = window.PKBUtils?.debounce(() => {
            if (window.reprocessMath) window.reprocessMath();
          }, 150) || (() => setTimeout(() => window.reprocessMath(), 150));
          debouncedMathReprocess();
        });

        // Handle visibility changes (tab switching)
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            const debouncedMathReprocess = window.PKBUtils?.debounce(() => {
              if (window.reprocessMath) window.reprocessMath();
            }, 150) || (() => setTimeout(() => window.reprocessMath(), 150));
            debouncedMathReprocess();
          }
        });
      }
    }
  };
</script>

<!-- Load MathJax script - using tex-chtml.js consistently -->
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
