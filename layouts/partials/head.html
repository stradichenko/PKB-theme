<!-- Sets the character encoding for the document to UTF-8 -->
<meta charset="utf-8">

<!-- Ensures proper rendering and touch zooming on mobile devices -->
<meta name="viewport" content="width=device-width">

<!-- Dynamically sets the page title -->
<title>{{ if .IsHome }}{{ site.Title }}{{ else }}{{ printf "%s | %s" .Title site.Title }}{{ end }}</title>

<!-- Critical theme initialization script -->
<script>
  (function() {
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const currentTheme = localStorage.getItem('theme') || 
                       (prefersDarkScheme.matches ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', currentTheme);
    document.documentElement.style.backgroundColor = 
      currentTheme === 'dark' ? '#1a202c' : '#275f85';
    document.documentElement.style.color = 
      currentTheme === 'dark' ? '#e2e8ff' : '#cad6ff';
  })();
</script>

<!-- Include critical JS first -->
{{ $criticalJS := resources.Get "js/critical.js" | js.Build | minify }}
<script>{{ $criticalJS.Content | safeJS }}</script>

<!-- INLINE CRITICAL SELECTION STYLES FOR IMMEDIATE APPLICATION -->
<style>
  /* Text selection highlighting with maximum specificity */
  *::selection {
    background-color: var(--color-primary, #4a90e2) !important;
    color: var(--color-white, #ffffff) !important;
    text-shadow: none !important;
  }
  
  *::-moz-selection {
    background-color: var(--color-primary, #4a90e2) !important;
    color: var(--color-white, #ffffff) !important;
    text-shadow: none !important;
  }
  
  /* Dark mode needs separate rules */
  html[data-theme="dark"] *::selection {
    background-color: #e9996b !important;
    color: #1a2633 !important;
  }
  
  html[data-theme="dark"] *::-moz-selection {
    background-color: #e9996b !important;
    color: #1a2633 !important;
  }
</style>

<!-- CENTRALIZED CSS LOADING - Proper cascade order -->
{{ if eq hugo.Environment "development" }}
  <!-- Development mode - Individual CSS files with source maps -->
  
  <!-- 1. Core styles - variables and reset first -->
  {{ with resources.Get "css/global/variables.css" }}
    {{ $variablesCSS := . | toCSS | fingerprint }}
    <link rel="stylesheet" href="{{ $variablesCSS.RelPermalink }}" integrity="{{ $variablesCSS.Data.Integrity }}" crossorigin="anonymous">
  {{ end }}
  
  {{ with resources.Get "css/global/reset.css" }}
    {{ $resetCSS := . | toCSS | fingerprint }}
    <link rel="stylesheet" href="{{ $resetCSS.RelPermalink }}" integrity="{{ $resetCSS.Data.Integrity }}" crossorigin="anonymous">
  {{ end }}

  <!-- 2. Layout components -->
  {{ with resources.Get "css/body.css" }}
    {{ $bodyCSS := . | toCSS | fingerprint }}
    <link rel="stylesheet" href="{{ $bodyCSS.RelPermalink }}" integrity="{{ $bodyCSS.Data.Integrity }}" crossorigin="anonymous">
  {{ end }}
  
  {{ with resources.Get "css/header.css" }}
    {{ $headerCSS := . | toCSS | fingerprint }}
    <link rel="stylesheet" href="{{ $headerCSS.RelPermalink }}" integrity="{{ $headerCSS.Data.Integrity }}" crossorigin="anonymous">
  {{ end }}
  
  {{ with resources.Get "css/footer.css" }}
    {{ $footerCSS := . | toCSS | fingerprint }}
    <link rel="stylesheet" href="{{ $footerCSS.RelPermalink }}" integrity="{{ $footerCSS.Data.Integrity }}" crossorigin="anonymous">
  {{ end }}
  
  <!-- 3. Component styles -->
  {{ with resources.Get "css/components/sidenote.css" }}
    {{ $sidenotesCSS := . | toCSS | fingerprint }}
    <link rel="stylesheet" href="{{ $sidenotesCSS.RelPermalink }}" integrity="{{ $sidenotesCSS.Data.Integrity }}" crossorigin="anonymous">
  {{ end }}
  
  {{ $tocCSS := resources.Get "css/components/toc.css" | fingerprint }}
  <link rel="stylesheet" href="{{ $tocCSS.RelPermalink }}" integrity="{{ $tocCSS.Data.Integrity }}" crossorigin="anonymous">
  
  {{ $tableCSS := resources.Get "css/components/table.css" | fingerprint }}
  <link rel="stylesheet" href="{{ $tableCSS.RelPermalink }}" integrity="{{ $tableCSS.Data.Integrity }}" crossorigin="anonymous">
  
  {{ $codeCSS := resources.Get "css/components/code.css" | fingerprint }}
  <link rel="stylesheet" href="{{ $codeCSS.RelPermalink }}" integrity="{{ $codeCSS.Data.Integrity }}" crossorigin="anonymous">
  
  {{ $listCSS := resources.Get "css/list.css" | toCSS | fingerprint }}
  <link rel="stylesheet" href="{{ $listCSS.RelPermalink }}" integrity="{{ $listCSS.Data.Integrity }}" crossorigin="anonymous">
  
  {{ $postsGridCSS := resources.Get "css/components/recent-posts-grid.css" | toCSS | fingerprint }}
  <link rel="stylesheet" href="{{ $postsGridCSS.RelPermalink }}" integrity="{{ $postsGridCSS.Data.Integrity }}" crossorigin="anonymous">
  
  {{ $aboutProfileCSS := resources.Get "css/about-profile.css" | toCSS | fingerprint }}
  <link rel="stylesheet" href="{{ $aboutProfileCSS.RelPermalink }}" integrity="{{ $aboutProfileCSS.Data.Integrity }}" crossorigin="anonymous">
  
  <!-- 4. Main CSS for global styles -->
  {{ $mainCSS := resources.Get "css/main.css" | toCSS | fingerprint }}
  <link rel="stylesheet" href="{{ $mainCSS.RelPermalink }}" integrity="{{ $mainCSS.Data.Integrity }}" crossorigin="anonymous">
  
  <!-- 5. Replace SCSS with regular CSS -->
  {{ with resources.Get "css/search.css" }}
    {{ $searchCSS := . | toCSS | fingerprint }}
    <link rel="stylesheet" href="{{ $searchCSS.RelPermalink }}" integrity="{{ $searchCSS.Data.Integrity }}" crossorigin="anonymous">
  {{ end }}
  
  <!-- 6. Theme toggle CSS - LOAD LAST to ensure overrides work -->
  {{ $themeToggleCSS := resources.Get "css/theme-toggle.css" | toCSS | fingerprint }}
  <link rel="stylesheet" href="{{ $themeToggleCSS.RelPermalink }}" integrity="{{ $themeToggleCSS.Data.Integrity }}" crossorigin="anonymous">
{{ else }}
  <!-- Production mode - Concatenated and minified CSS -->
  {{ $cssFiles := slice 
      (resources.Get "css/global/variables.css")
      (resources.Get "css/global/reset.css")
      (resources.Get "css/body.css")
      (resources.Get "css/header.css") 
      (resources.Get "css/footer.css")
      (resources.Get "css/components/sidenote.css")
      (resources.Get "css/components/toc.css")
      (resources.Get "css/components/table.css")
      (resources.Get "css/components/code.css")
      (resources.Get "css/list.css")
      (resources.Get "css/components/recent-posts-grid.css")
      (resources.Get "css/about-profile.css")
      (resources.Get "css/main.css")
  }}
  {{ $combinedCSS := $cssFiles | resources.Concat "css/all.css" | toCSS | minify | fingerprint }}
  <link rel="stylesheet" href="{{ $combinedCSS.RelPermalink }}" integrity="{{ $combinedCSS.Data.Integrity }}" crossorigin="anonymous">
  
  <!-- Include regular CSS -->
  {{ with resources.Get "css/search.css" }}
    {{ $searchCSS := . | toCSS | minify | fingerprint }}
    <link rel="stylesheet" href="{{ $searchCSS.RelPermalink }}" integrity="{{ $searchCSS.Data.Integrity }}" crossorigin="anonymous">
  {{ end }}
  
  <!-- Load theme-toggle CSS last to ensure it overrides all other styles -->
  {{ $themeToggleCSS := resources.Get "css/theme-toggle.css" | toCSS | minify | fingerprint }}
  <link rel="stylesheet" href="{{ $themeToggleCSS.RelPermalink }}" integrity="{{ $themeToggleCSS.Data.Integrity }}" crossorigin="anonymous">
{{ end }}

<!-- JavaScript loading -->
{{ with resources.Get "js/main.js" }}
  {{ $mainJS := . | js.Build | minify | fingerprint }}
  <script src="{{ $mainJS.RelPermalink }}" integrity="{{ $mainJS.Data.Integrity }}" crossorigin="anonymous"></script>
{{ end }}