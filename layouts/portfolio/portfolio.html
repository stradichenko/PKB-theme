{{ define "main" }}
  {{- $jsonURL := (.OutputFormats.Get "JSON").RelPermalink }}
  {{ with $jsonURL }}
    <link rel="preload" as="fetch" href="{{ . }}" type="application/json">
  {{ end }}
  
  <!-- Add portfolio CSS -->
  <link rel="stylesheet" href="/assets/css/portfolio.css">

  <div class="portfolio-container">
    <header class="portfolio-header">
      <h1 class="portfolio-title">{{ .Title | default "Portfolio" }}</h1>
      {{ with .Content }}<div class="portfolio-description">{{ . }}</div>{{ end }}
    </header>

    <div class="portfolio-filters" id="portfolioFilters">
      <button class="filter-btn active" data-filter="all">All</button>
    </div>

    <div class="portfolio-subfilters">
      <div class="subfilter-group">
        <label>Format:</label>
        <select id="formatSelect"><option value="all">All</option></select>
      </div>

      <div class="subfilter-group">
        <label>Orientation:</label>
        <select id="orientationSelect">
          <option value="all">All</option>
          <option value="landscape">Landscape</option>
          <option value="portrait">Portrait</option>
          <option value="square">Square</option>
        </select>
      </div>

      <div class="subfilter-group">
        <label>Camera Model:</label>
        <select id="cameraSelect"><option value="all">All</option></select>
      </div>

      <div class="subfilter-group">
        <label>Dominant Color:</label>
        <select id="colorSelect"><option value="all">All</option></select>
      </div>

      <div class="subfilter-group">
        <button id="clearFilters" class="clear-filters-btn">Clear All Filters</button>
      </div>
    </div>

    <div class="portfolio-stats" id="portfolioStats">
      <span class="stat-item"><strong>0</strong> Images</span>
      <span class="stat-item"><strong>0</strong> Categories</span>
    </div>

    <div class="portfolio-loading" id="portfolioLoading">
      <div class="loading-spinner"></div>
      <p>Loading portfolio...</p>
    </div>

    <div class="portfolio-grid" id="portfolioGrid" data-json-url="{{ $jsonURL }}">
      <!-- Masonry columns will be rendered here -->
    </div>

    <div class="portfolio-overlay" id="portfolioOverlay">
      <div class="overlay-content">
        <button class="overlay-close" id="overlayClose">&times;</button>
        <div class="overlay-main">
          <div class="overlay-image-container">
            <img class="overlay-image" id="overlayImage" alt="">
            <div class="overlay-navigation">
              <button class="nav-btn nav-prev" id="navPrev">&#8249;</button>
              <button class="nav-btn nav-next" id="navNext">&#8250;</button>
            </div>
          </div>
          <aside class="overlay-sidebar">
            <div class="image-metadata">
              <h3 class="metadata-title">Image Details</h3>
              <div class="metadata-content" id="metadataContent"></div>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>

  <!-- Load external JS for portfolio logic -->
  <script src="/assets/js/portfolio.js"></script>

  <script>
  (async () => {
    const gridEl = document.getElementById('portfolioGrid');
    const url = gridEl.getAttribute('data-json-url');
    const resp = await fetch(url);
    const data = await resp.json();

    const filtersEl = document.getElementById('portfolioFilters');
    const formatSelect = document.getElementById('formatSelect');
    const orientationSelect = document.getElementById('orientationSelect');
    const cameraSelect = document.getElementById('cameraSelect');
    const colorSelect = document.getElementById('colorSelect');

    const formats = new Set();
    const cameras = new Set();
    const colors = new Set();

    data.portfolio_metadata.category_list.forEach(cat => {
      const btn = document.createElement('button');
      btn.className = 'filter-btn';
      btn.dataset.filter = cat;
      btn.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      filtersEl.appendChild(btn);
    });

    data.images.forEach(img => {
      formats.add(img.pkb_format);
      if (img.pkb_exif_model) cameras.add(img.pkb_exif_model);
      (img.pkb_dominant_colors || []).forEach(c => colors.add(c));
    });

    [...formats].sort().forEach(fmt => {
      const option = document.createElement('option');
      option.value = fmt;
      option.textContent = fmt.toUpperCase();
      formatSelect.appendChild(option);
    });

    [...cameras].sort().forEach(cam => {
      const option = document.createElement('option');
      option.value = cam;
      option.textContent = cam;
      cameraSelect.appendChild(option);
    });

    [...colors].sort().forEach(clr => {
      const option = document.createElement('option');
      option.value = clr;
      option.textContent = clr.charAt(0).toUpperCase() + clr.slice(1);
      colorSelect.appendChild(option);
    });

    function getColumnCount() {
      if (window.innerWidth < 600) return 1;
      if (window.innerWidth < 900) return 2;
      if (window.innerWidth < 1200) return 3;
      return 4;
    }

    function distributeToColumns(items, colCount) {
      const cols = Array.from({ length: colCount }, () => []);
      items.forEach((item, idx) => {
        cols[idx % colCount].push(item);
      });
      return cols;
    }

    function renderGrid(category, format, orientation, camera, color) {
      const filtered = data.images.filter(img => {
        const catMatch = category === 'all' || img.pkb_category === category;
        const fmtMatch = format === 'all' || img.pkb_format === format;
        const oriMatch = orientation === 'all' || img.pkb_orientation === orientation;
        const camMatch = camera === 'all' || img.pkb_exif_model === camera;
        const clrMatch = color === 'all' || (img.pkb_color_families || []).includes(color);
        return catMatch && fmtMatch && oriMatch && camMatch && clrMatch;
      });

      // Update stats with filtered count
      updateStats(filtered, category);

      const colCount = getColumnCount();
      const columns = distributeToColumns(filtered, colCount);

      gridEl.innerHTML = columns.map(colImgs => `
        <div class="masonry-column">
          ${colImgs.map(img => {
            const width = img.pkb_original_width || 1;
            const height = img.pkb_original_height || 1;
            return `
              <div class="portfolio-item" data-category="${img.pkb_category}" data-format="${img.pkb_format}" style="width: 100%;">
                <div class="item-container" style="aspect-ratio: ${width} / ${height}; width: 100%;">
                  <img class="portfolio-image" src="${img.pkb_thumbnail_300_300.url}" alt="${img.pkb_filename}" loading="lazy" style="width: 100%; height: 100%;" data-full-src="${img.pkb_optimized.url}" />
                  <div class="item-overlay">
                    <div class="item-info">
                      <span class="item-category">${img.pkb_category}</span>
                      <span class="item-dimensions">${width}Ã—${height}</span>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `).join('');

      gridEl.querySelectorAll('.portfolio-image').forEach(img => {
        if (img.complete) {
          img.classList.add('loaded');
        } else {
          img.addEventListener('load', () => img.classList.add('loaded'));
          img.addEventListener('error', () => img.classList.add('error'));
        }
      });
    }

    function updateStats(filteredImages, activeCategory) {
      const statsEl = document.getElementById('portfolioStats');
      
      // Count unique categories in filtered results
      const filteredCategories = new Set();
      filteredImages.forEach(img => {
        if (img.pkb_category) {
          filteredCategories.add(img.pkb_category);
        }
      });

      // Show different stats based on filter state
      const isFiltered = activeCategory !== 'all' || 
                        activeFormat !== 'all' || 
                        activeOrientation !== 'all' || 
                        activeCamera !== 'all' || 
                        activeColor !== 'all';

      if (isFiltered) {
        statsEl.innerHTML = `
          <span class="stat-item"><strong>${filteredImages.length}</strong> of ${data.portfolio_metadata.total_images} Images</span>
          <span class="stat-item"><strong>${filteredCategories.size}</strong> of ${data.portfolio_metadata.category_list.length} Categories</span>
        `;
      } else {
        statsEl.innerHTML = `
          <span class="stat-item"><strong>${data.portfolio_metadata.total_images}</strong> Images</span>
          <span class="stat-item"><strong>${data.portfolio_metadata.category_list.length}</strong> Categories</span>
        `;
      }
    }

    let activeCategory = 'all';
    let activeFormat = 'all';
    let activeOrientation = 'all';
    let activeCamera = 'all';
    let activeColor = 'all';

    renderGrid(activeCategory, activeFormat, activeOrientation, activeCamera, activeColor);

    filtersEl.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        filtersEl.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeCategory = btn.dataset.filter;
        renderGrid(activeCategory, activeFormat, activeOrientation, activeCamera, activeColor);
      });
    });

    formatSelect.addEventListener('change', e => {
      activeFormat = e.target.value;
      renderGrid(activeCategory, activeFormat, activeOrientation, activeCamera, activeColor);
    });

    orientationSelect.addEventListener('change', e => {
      activeOrientation = e.target.value;
      renderGrid(activeCategory, activeFormat, activeOrientation, activeCamera, activeColor);
    });

    cameraSelect.addEventListener('change', e => {
      activeCamera = e.target.value;
      renderGrid(activeCategory, activeFormat, activeOrientation, activeCamera, activeColor);
    });

    colorSelect.addEventListener('change', e => {
      activeColor = e.target.value;
      renderGrid(activeCategory, activeFormat, activeOrientation, activeCamera, activeColor);
    });

    document.getElementById('clearFilters').addEventListener('click', () => {
      activeCategory = 'all';
      activeFormat = 'all';
      activeOrientation = 'all';
      activeCamera = 'all';
      activeColor = 'all';

      // Fix: Properly reset the category filter buttons
      filtersEl.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      filtersEl.querySelector('.filter-btn[data-filter="all"]').classList.add('active');

      formatSelect.value = 'all';
      orientationSelect.value = 'all';
      cameraSelect.value = 'all';
      colorSelect.value = 'all';

      renderGrid(activeCategory, activeFormat, activeOrientation, activeCamera, activeColor);
    });

    window.addEventListener('resize', () => {
      renderGrid(activeCategory, activeFormat, activeOrientation, activeCamera, activeColor);
    });

    document.getElementById('portfolioLoading').style.display = 'none';
  })();
  </script>
{{ end }}
