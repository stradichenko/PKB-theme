{{- /* File: layouts/portfolio/single.json */ -}}
{{- if eq (site.Params.portfolioIndexing | default true) false -}}
{{- dict
  "portfolio_metadata" (dict
    "total_images" 0
    "supported_formats" (slice)
    "generated_at" (now.Format "2006-01-02T15:04:05Z07:00")
    "hugo_version" hugo.Version
    "pkb_schema_version" "1.0.0"
    "category_list" (slice)
    "indexing_disabled" true
  )
  "images" (slice)
| jsonify -}}
{{- else -}}
{{- $supportedFormats := slice "jpg" "jpeg" "png" "webp" "gif" "tiff" "tif" -}}
{{- $thumbnailSizes := slice "300x300" "600x400" "1200x800" -}}
{{- $portfolioImages := slice -}}

{{- $resources := slice -}}
{{- with .Resources }}
  {{- $resources = . -}}
{{- else }}
  {{- $resources = resources.Match "images/portfolio/**" -}}
{{- end -}}

{{- range $image := $resources -}}
  {{- $ext := lower (path.Ext $image.RelPermalink) -}}
  {{- $cleanExt := strings.TrimLeft "." $ext -}}
  {{- if in $supportedFormats $cleanExt -}}

    {{- $pathParts := split (strings.TrimPrefix "/images/portfolio/" $image.RelPermalink) "/" -}}
    {{- $category := "general" -}}
    {{- if gt (len $pathParts) 1 -}}
      {{- $category = index $pathParts 0 -}}
    {{- end -}}

    {{- $imageData := dict
      "pkb_image_id" (printf "%s_%s" $category (path.BaseName $image.RelPermalink))
      "pkb_category" $category
      "pkb_filename" (path.Base $image.RelPermalink)
      "pkb_original_width" $image.Width
      "pkb_original_height" $image.Height
      "pkb_file_size" (len $image.Content)
      "pkb_format" $cleanExt
      "pkb_permalink" $image.Permalink
      "pkb_rel_permalink" $image.RelPermalink
    -}}

    {{- with $image.Exif -}}
      {{- $exif := dict
        "pkb_exif_make" (.Tags.Make | default "")
        "pkb_exif_model" (.Tags.Model | default "")
        "pkb_exif_lens_model" (.Tags.LensModel | default "")
        "pkb_exif_exposure_time" (.Tags.ExposureTime | default "")
        "pkb_exif_f_number" (.Tags.FNumber | default "")
        "pkb_exif_iso" (.Tags.ISOSpeedRatings | default "")
      -}}
      {{- with .Date -}}
        {{- $exif = merge $exif (dict "pkb_exif_date" (.Format "2006-01-02T15:04:05Z07:00")) -}}
      {{- end -}}
      {{- $imageData = merge $imageData $exif -}}
    {{- end -}}

    {{- /* Thumbnails */ -}}
    {{- $thumbnails := dict -}}
    {{- range $size := $thumbnailSizes -}}
      {{- $thumbnail := $image.Fill (printf "%s Smart q85 webp" $size) -}}
      {{- $key := printf "pkb_thumbnail_%s" (replace $size "x" "_") -}}
      {{- $thumbnails = merge $thumbnails (dict $key (dict
        "url" $thumbnail.RelPermalink
        "width" $thumbnail.Width
        "height" $thumbnail.Height
      )) -}}
    {{- end -}}
    {{- $imageData = merge $imageData $thumbnails -}}

    {{- /* Optimized */ -}}
    {{- $optimizedWebP := $image.Process "webp q85" -}}
    {{- $optimizedJPEG := $image.Process "jpeg q85" -}}
    {{- $imageData = merge $imageData (dict
      "pkb_optimized_webp" (dict
        "url" $optimizedWebP.RelPermalink
        "width" $optimizedWebP.Width
        "height" $optimizedWebP.Height
      )
      "pkb_optimized_jpeg" (dict
        "url" $optimizedJPEG.RelPermalink
        "width" $optimizedJPEG.Width
        "height" $optimizedJPEG.Height
      )
    ) -}}

    {{- /* Aspect Ratio & Orientation */ -}}
    {{- $aspectRatio := div (float $image.Width) (float $image.Height) -}}
    {{- $orientation := cond (gt $aspectRatio 1.05) "landscape" (cond (lt $aspectRatio 0.95) "portrait" "square") -}}
    {{- $imageData = merge $imageData (dict
      "pkb_aspect_ratio" $aspectRatio
      "pkb_orientation" $orientation
    ) -}}

    {{- /* Dominant Colors â€” use Hugo built-in .Colors (already sorted by frequency) */ -}}
    {{- $colorSample := $image.Fit "32x32" -}}
    {{- $imageData = merge $imageData (dict
      "pkb_dominant_colors" (first 5 $colorSample.Colors)
    ) -}}

    {{- $portfolioImages = $portfolioImages | append $imageData -}}
  {{- end -}}
{{- end -}}

{{- $categoryList := slice -}}
{{- range $portfolioImages }}
  {{- $cat := .pkb_category | default "uncategorized" -}}
  {{- if not (in $categoryList $cat) }}
    {{- $categoryList = $categoryList | append $cat -}}
  {{- end -}}
{{- end -}}

{{- dict
  "portfolio_metadata" (dict
    "total_images" (len $portfolioImages)
    "supported_formats" $supportedFormats
    "generated_at" (now.Format "2006-01-02T15:04:05Z07:00")
    "hugo_version" hugo.Version
    "pkb_schema_version" "1.0.0"
    "category_list" $categoryList
  )
  "images" $portfolioImages
| jsonify -}}
{{- end -}}
