<!DOCTYPE html>
<html lang="{{ or site.Language.LanguageCode }}" dir="{{ or site.Language.LanguageDirection `ltr` }}" class="interaction" data-base-url="{{ .Site.BaseURL }}">
<head>
  <!-- Critical theme initialization script - improved for persistence -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      const currentTheme = savedTheme || (prefersDarkScheme.matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', currentTheme);

      const rootStyle = document.documentElement.style;
      if (currentTheme === 'dark') {
        rootStyle.setProperty('--critical-bg', 'var(--dark-background, #1a202c)');
        rootStyle.setProperty('--critical-text', 'var(--dark-text-primary, #e2e8ff)');
      } else {
        rootStyle.setProperty('--critical-bg', 'var(--light-background, #275f85)');
        rootStyle.setProperty('--critical-text', 'var(--light-text-secondary, #cad6ff)');
      }

      if (!savedTheme) {
        localStorage.setItem('theme', currentTheme);
      }
    })();
  </script>

  <style>
    html[data-theme="dark"],
    html[data-theme="dark"] body,
    html[data-theme="dark"] main,
    html[data-theme="dark"] .content {
      background-color: var(--dark-background, #1a202c) !important;
      color: var(--dark-text-primary, #e2e8ff) !important;
    }

    html[data-theme="light"],
    html[data-theme="light"] body,
    html[data-theme="light"] main,
    html[data-theme="light"] .content {
      background-color: var(--light-background, #275f85) !important;
      color: var(--light-text-secondary, #cad6ff) !important;
    }

    html {
      background-color: var(--critical-bg, var(--color-background));
      color: var(--critical-text, var(--color-text-primary));
    }
  </style>

  {{ partial "head.html" . }}
  {{ block "head" . }}{{ end }}
  {{ if .Param "math" }}
    {{ partialCached "math.html" . }}
  {{ end }}

  {{ $mainCSS := resources.Get "css/main.css" }}
  {{ if $mainCSS }}
    {{ $css := $mainCSS | minify | fingerprint }}
    <link rel="preload" href="{{ $css.RelPermalink }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ $css.RelPermalink }}"></noscript>
    <link rel="stylesheet" href="{{ $css.RelPermalink }}" media="print" onload="this.media='all'">
  {{ end }}
</head>
<body>
  <header>
    {{ partial "header.html" . }}
  </header>
  <main>
    {{ block "main" . }}{{ end }}
  </main>
  <footer>
    {{ partial "footer.html" . }}
  </footer>

  {{ if not .IsSection }}
    {{ $pdfGenerator := resources.Get "js/pdf-generator.js" }}
    {{ if $pdfGenerator }}
      {{ $pdfGeneratorMin := $pdfGenerator | minify | fingerprint }}
      <script src="{{ $pdfGeneratorMin.RelPermalink }}" defer></script>
    {{ end }}
  {{ end }}

  {{ if .Store.Get "hasMermaid" }}
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    document.addEventListener('DOMContentLoaded', function() {
      mermaid.initialize({
        theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'
      });

      const mermaidElements = document.querySelectorAll('.mermaid-diagram .mermaid');
      mermaidElements.forEach((element, index) => {
        const id = `mermaid-${index}`;
        const graphDefinition = element.textContent;
        mermaid.render(id, graphDefinition).then(({ svg }) => {
          element.innerHTML = svg;
        }).catch((error) => {
          element.innerHTML = `<div class="mermaid-error">Error rendering diagram: ${error.message}</div>`;
        });
      });

      if (typeof window.mermaidThemeObserver === 'undefined') {
        window.mermaidThemeObserver = new MutationObserver(mutations => {
          mutations.forEach(mutation => {
            if (mutation.attributeName === 'data-theme') {
              const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default';
              mermaid.initialize({ theme: newTheme });
              mermaidElements.forEach((element, index) => {
                const graphDefinition = element.getAttribute('data-original') || element.textContent;
                mermaid.render(`mermaid-${index}`, graphDefinition).then(({ svg }) => {
                  element.innerHTML = svg;
                });
              });
            }
          });
        });
        window.mermaidThemeObserver.observe(document.documentElement, { attributes: true });
      }
    });
  </script>
  {{ end }}

  {{ if .Param "math" }}
  <script>
    let mathProcessingAttempts = 0;

    function ensureMathProcessing() {
      if (mathProcessingAttempts > 5) return;
      mathProcessingAttempts++;

      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise().catch((err) => {
          console.warn('MathJax typeset error:', err);
          setTimeout(ensureMathProcessing, 200);
        });
      } else {
        setTimeout(ensureMathProcessing, 200);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(ensureMathProcessing, 100);
    });

    window.addEventListener('load', () => {
      setTimeout(ensureMathProcessing, 200);
    });

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        mathProcessingAttempts = 0;
        setTimeout(ensureMathProcessing, 150);
      }
    });

    setInterval(() => {
      const unprocessedMath = document.querySelectorAll('script[type="math/tex"], script[type="math/tex; mode=display"]');
      if (unprocessedMath.length > 0 && window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
    }, 2000);
  </script>
  {{ end }}
</body>
</html>
