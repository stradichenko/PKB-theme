<!DOCTYPE html>
<html lang="{{ or site.Language.LanguageCode }}" dir="{{ or site.Language.LanguageDirection `ltr` }}" class="interaction" data-base-url="{{ .Site.BaseURL }}">
<head>
  <meta name="site-base-url" content="{{ .Site.BaseURL | relURL }}">

  <!-- ðŸŒ‘ Critical theme setup (MUST stay in head) -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      const currentTheme = savedTheme || (prefersDarkScheme.matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', currentTheme);

      const rootStyle = document.documentElement.style;
      if (currentTheme === 'dark') {
        rootStyle.setProperty('--critical-bg', 'var(--dark-background, #1a202c)');
        rootStyle.setProperty('--critical-text', 'var(--dark-text-primary, #e2e8ff)');
      } else {
        rootStyle.setProperty('--critical-bg', 'var(--light-background, #275f85)');
        rootStyle.setProperty('--critical-text', 'var(--light-text-secondary, #cad6ff)');
      }

      if (!savedTheme) {
        localStorage.setItem('theme', currentTheme);
      }
    })();
  </script>

  <!-- ðŸ§± Critical CSS for no-flash experience -->
  <style>
    html[data-theme="dark"] body,
    html[data-theme="light"] body,
    html {
      background-color: var(--critical-bg, var(--color-background));
      color: var(--critical-text, var(--color-text-primary));
      /* Add font fallbacks for critical rendering */
      font-family: Arial, -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      font-display: swap;
    }
    
    /* Prevent font loading flicker */
    * {
      font-display: swap;
    }
  </style>

  {{ partial "head.html" . }}
  {{ block "head" . }}{{ end }}

  <!-- Include analytics scripts in head -->
  {{ partial "analytics.html" . }}

  {{ if .Param "math" }}
    {{ partial "math.html" . }}
  {{ end }}

  <!-- ðŸ”— Main CSS with preload -->
  {{ $mainCSS := resources.Get "css/main.css" }}
  {{ if $mainCSS }}
    {{ $css := $mainCSS | minify | fingerprint }}
    <link rel="preload" href="{{ $css.RelPermalink }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ $css.RelPermalink }}"></noscript>
    <link rel="stylesheet" href="{{ $css.RelPermalink }}" media="print" onload="this.media='all'">
  {{ end }}
</head>

<body>
  <header>
    {{ partial "header.html" . }}
  </header>

  <main>
    {{ block "main" . }}{{ end }}
  </main>

  <footer>
    {{ partial "footer.html" . }}
  </footer>

  <!-- ðŸ“¦ Defer non-critical JavaScript to the end of body -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      // PDF Generator
      {{ if not .IsSection }}
        {{ $pdfGenerator := resources.Get "js/pdf-generator.js" }}
        {{ if $pdfGenerator }}
          {{ $pdfGeneratorMin := $pdfGenerator | minify | fingerprint }}
          const pdfScript = document.createElement('script');
          pdfScript.src = '{{ $pdfGeneratorMin.RelPermalink }}';
          pdfScript.defer = true;
          document.body.appendChild(pdfScript);
        {{ end }}
      {{ end }}

      // Mermaid.js
      {{ if .Store.Get "hasMermaid" }}
        {{ $mermaidJS := resources.Get "js/mermaid.min.js" }}
        {{ if $mermaidJS }}
          {{ $mermaidMin := $mermaidJS | minify | fingerprint }}
          const mermaidPath = '{{ $mermaidMin.RelPermalink }}';
        {{ else }}
          const mermaidPath = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        {{ end }}

        const loadMermaid = async () => {
          const mermaid = (await import(mermaidPath)).default;
          mermaid.initialize({
            theme: document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'
          });

          const mermaidElements = document.querySelectorAll('.mermaid-diagram .mermaid');
          mermaidElements.forEach((element, index) => {
            const id = `mermaid-${index}`;
            const graphDefinition = element.textContent;
            mermaid.render(id, graphDefinition).then(({ svg }) => {
              element.innerHTML = svg;
            }).catch((error) => {
              element.innerHTML = `<div class="mermaid-error">Error rendering diagram: ${error.message}</div>`;
            });
          });

          // Theme switch observer
          if (typeof window.mermaidThemeObserver === 'undefined') {
            window.mermaidThemeObserver = new MutationObserver(mutations => {
              mutations.forEach(mutation => {
                if (mutation.attributeName === 'data-theme') {
                  const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default';
                  mermaid.initialize({ theme: newTheme });
                  mermaidElements.forEach((element, index) => {
                    const graphDefinition = element.getAttribute('data-original') || element.textContent;
                    mermaid.render(`mermaid-${index}`, graphDefinition).then(({ svg }) => {
                      element.innerHTML = svg;
                    });
                  });
                }
              });
            });
            window.mermaidThemeObserver.observe(document.documentElement, { attributes: true });
          }
        };

        loadMermaid();
      {{ end }}
    });
  </script>
</body>
</html>
